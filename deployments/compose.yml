services:
  ntpu-linebot:
    image: garyellow/ntpu-linebot-go:${NTPU_IMAGE_TAG:-latest}
    container_name: ntpu-linebot
    restart: unless-stopped
    ports:
      - "${NTPU_HOST_PORT:-10000}:${NTPU_PORT:-10000}"
    volumes:
      - data:/data:rw
    environment:
      # Core (required)
      - NTPU_LINE_CHANNEL_ACCESS_TOKEN=${NTPU_LINE_CHANNEL_ACCESS_TOKEN:?NTPU_LINE_CHANNEL_ACCESS_TOKEN is required}
      - NTPU_LINE_CHANNEL_SECRET=${NTPU_LINE_CHANNEL_SECRET:?NTPU_LINE_CHANNEL_SECRET is required}

      # Server
      - NTPU_LOG_LEVEL=${NTPU_LOG_LEVEL:-info}
      - NTPU_PORT=${NTPU_PORT:-10000}
      - NTPU_SHUTDOWN_TIMEOUT=${NTPU_SHUTDOWN_TIMEOUT:-30s}
      - NTPU_SERVER_NAME=${NTPU_SERVER_NAME:-}
      - NTPU_INSTANCE_ID=${NTPU_INSTANCE_ID:-}

      # Data
      - NTPU_CACHE_TTL=${NTPU_CACHE_TTL:-168h}
      - NTPU_DATA_DIR=${NTPU_DATA_DIR:-/data}

      # Scraper
      - NTPU_SCRAPER_MAX_RETRIES=${NTPU_SCRAPER_MAX_RETRIES:-10}
      - NTPU_SCRAPER_TIMEOUT=${NTPU_SCRAPER_TIMEOUT:-60s}

      # Webhook
      - NTPU_WEBHOOK_TIMEOUT=${NTPU_WEBHOOK_TIMEOUT:-60s}

      # Rate limits
      - NTPU_GLOBAL_RATE_RPS=${NTPU_GLOBAL_RATE_RPS:-100}
      - NTPU_USER_RATE_BURST=${NTPU_USER_RATE_BURST:-15}
      - NTPU_USER_RATE_REFILL=${NTPU_USER_RATE_REFILL:-0.1}
      - NTPU_LLM_RATE_BURST=${NTPU_LLM_RATE_BURST:-60}
      - NTPU_LLM_RATE_DAILY=${NTPU_LLM_RATE_DAILY:-180}
      - NTPU_LLM_RATE_REFILL=${NTPU_LLM_RATE_REFILL:-30}

      # Background task scheduling
      - NTPU_WARMUP_GRACE_PERIOD=${NTPU_WARMUP_GRACE_PERIOD:-10m}
      - NTPU_WARMUP_WAIT=${NTPU_WARMUP_WAIT:-false}
      - NTPU_DATA_REFRESH_INTERVAL=${NTPU_DATA_REFRESH_INTERVAL:-24h}
      - NTPU_DATA_CLEANUP_INTERVAL=${NTPU_DATA_CLEANUP_INTERVAL:-24h}

      # LLM
      - NTPU_LLM_ENABLED=${NTPU_LLM_ENABLED:-false}
      - NTPU_GEMINI_API_KEY=${NTPU_GEMINI_API_KEY:-}
      - NTPU_GROQ_API_KEY=${NTPU_GROQ_API_KEY:-}
      - NTPU_CEREBRAS_API_KEY=${NTPU_CEREBRAS_API_KEY:-}
      - NTPU_LLM_PROVIDERS=${NTPU_LLM_PROVIDERS:-gemini,groq,cerebras}
      - NTPU_GEMINI_INTENT_MODELS=${NTPU_GEMINI_INTENT_MODELS:-}
      - NTPU_GEMINI_EXPANDER_MODELS=${NTPU_GEMINI_EXPANDER_MODELS:-}
      - NTPU_GROQ_INTENT_MODELS=${NTPU_GROQ_INTENT_MODELS:-}
      - NTPU_GROQ_EXPANDER_MODELS=${NTPU_GROQ_EXPANDER_MODELS:-}
      - NTPU_CEREBRAS_INTENT_MODELS=${NTPU_CEREBRAS_INTENT_MODELS:-}
      - NTPU_CEREBRAS_EXPANDER_MODELS=${NTPU_CEREBRAS_EXPANDER_MODELS:-}

      # Better Stack
      - NTPU_BETTERSTACK_ENABLED=${NTPU_BETTERSTACK_ENABLED:-false}
      - NTPU_BETTERSTACK_ENDPOINT=${NTPU_BETTERSTACK_ENDPOINT:-}
      - NTPU_BETTERSTACK_TOKEN=${NTPU_BETTERSTACK_TOKEN:-}

      # Sentry
      - NTPU_SENTRY_ENABLED=${NTPU_SENTRY_ENABLED:-false}
      - NTPU_SENTRY_DSN=${NTPU_SENTRY_DSN:-}
      - NTPU_SENTRY_ENVIRONMENT=${NTPU_SENTRY_ENVIRONMENT:-}
      - NTPU_SENTRY_RELEASE=${NTPU_SENTRY_RELEASE:-}
      - NTPU_SENTRY_SAMPLE_RATE=${NTPU_SENTRY_SAMPLE_RATE:-1.0}
      - NTPU_SENTRY_TRACES_SAMPLE_RATE=${NTPU_SENTRY_TRACES_SAMPLE_RATE:-0.0}

      # Metrics
      - NTPU_METRICS_AUTH_ENABLED=${NTPU_METRICS_AUTH_ENABLED:-false}
      - NTPU_METRICS_PASSWORD=${NTPU_METRICS_PASSWORD:-}
      - NTPU_METRICS_USERNAME=${NTPU_METRICS_USERNAME:-prometheus}

      # R2 snapshot
      - NTPU_R2_ENABLED=${NTPU_R2_ENABLED:-false}
      - NTPU_R2_ACCOUNT_ID=${NTPU_R2_ACCOUNT_ID:-}
      - NTPU_R2_ACCESS_KEY_ID=${NTPU_R2_ACCESS_KEY_ID:-}
      - NTPU_R2_SECRET_ACCESS_KEY=${NTPU_R2_SECRET_ACCESS_KEY:-}
      - NTPU_R2_BUCKET_NAME=${NTPU_R2_BUCKET_NAME:-}
      - NTPU_R2_SNAPSHOT_KEY=${NTPU_R2_SNAPSHOT_KEY:-snapshots/cache.db.zst}
      - NTPU_R2_LOCK_KEY=${NTPU_R2_LOCK_KEY:-locks/crawler.json}
      - NTPU_R2_LOCK_TTL=${NTPU_R2_LOCK_TTL:-1h}
      - NTPU_R2_SNAPSHOT_POLL_INTERVAL=${NTPU_R2_SNAPSHOT_POLL_INTERVAL:-15m}
      - NTPU_R2_DELTA_PREFIX=${NTPU_R2_DELTA_PREFIX:-deltas}
      - NTPU_R2_SCHEDULE_KEY=${NTPU_R2_SCHEDULE_KEY:-schedules/maintenance.json}
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.2'
          memory: 128M
    logging:
      driver: json-file
      options:
        max-size: 50m
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=64M
    healthcheck:
      test: ["CMD", "/app/healthcheck"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

volumes:
  data:
