# Prometheus Alert Rules for NTPU LINE Bot
#
# Design Philosophy:
# - Focus on user-impacting issues (SLI-based alerts)
# - Avoid alert fatigue with appropriate thresholds
# - Use recording rules to pre-compute expensive queries
# - Tiered severity: info (low), warning (medium), critical (high)

groups:
  # ============================================
  # Alert Rules
  # ============================================
  - name: ntpu_alerts
    interval: 30s
    rules:
      # ----------------------------------------
      # Service Health (Critical)
      # ----------------------------------------
      - alert: ServiceDown
        expr: up{job="ntpu-linebot"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "NTPU LINE Bot is down"
          description: "Service has been unreachable for more than 2 minutes"

      # ----------------------------------------
      # Webhook SLO Alerts
      # Target: 95% of requests < 2s (LINE best practice)
      # ----------------------------------------
      - alert: WebhookLatencyHigh
        expr: ntpu:webhook_latency_p95:5m > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Webhook P95 latency is high"
          description: "P95 latency is {{ $value | printf \"%.2f\" }}s (target: <2s)"

      - alert: WebhookErrorRateHigh
        expr: (1 - ntpu:webhook_success_rate:5m) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Webhook error rate is high"
          description: "Error rate is {{ $value | humanizePercentage }} (target: <5%)"

      # ----------------------------------------
      # Scraper Alerts
      # External dependency monitoring
      # ----------------------------------------
      - alert: ScraperFailureRateHigh
        expr: (1 - ntpu:scraper_success_rate:5m) > 0.3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Scraper {{ $labels.module }} failure rate is high"
          description: "Failure rate is {{ $value | humanizePercentage }} (threshold: 30%)"

      - alert: ScraperLatencyHigh
        expr: ntpu:scraper_latency_p95:5m > 30
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Scraper {{ $labels.module }} latency is high"
          description: "P95 latency is {{ $value | printf \"%.1f\" }}s (threshold: 30s)"

      # ----------------------------------------
      # Cache Alerts
      # Data freshness and efficiency
      # ----------------------------------------
      - alert: CacheHitRateLow
        expr: ntpu:cache_hit_rate_total:5m < 0.5
        for: 1h
        labels:
          severity: info
        annotations:
          summary: "Cache hit rate is low"
          description: "Overall hit rate is {{ $value | humanizePercentage }} (target: >50%)"

      # ----------------------------------------
      # LLM Alerts
      # API reliability and cost awareness
      # ----------------------------------------
      - alert: LLMErrorRateHigh
        expr: (1 - ntpu:llm_success_rate:5m) > 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "LLM {{ $labels.operation }} error rate is high"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 20%)"

      - alert: LLMLatencyHigh
        expr: ntpu:llm_latency_p95:5m > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "LLM {{ $labels.operation }} latency is high"
          description: "P95 latency is {{ $value | printf \"%.2f\" }}s (threshold: 5s)"

      # ----------------------------------------
      # Search Alerts
      # BM25 semantic search quality
      # ----------------------------------------
      - alert: SearchIndexEmpty
        expr: ntpu_index_size{index="bm25"} == 0
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "BM25 search index is empty"
          description: "BM25 index has no documents, semantic search is disabled"

      - alert: SearchLatencyHigh
        expr: ntpu:search_latency_p95:5m > 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Search latency is high"
          description: "P95 latency is {{ $value | printf \"%.2f\" }}s (threshold: 3s)"

      # ----------------------------------------
      # Rate Limiter Alerts
      # Traffic protection
      # ----------------------------------------
      - alert: RateLimiterDroppingRequests
        expr: |
          sum(rate(ntpu_rate_limiter_dropped_total[5m])) > 1
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "Rate limiter is dropping requests"
          description: "Dropping {{ $value | printf \"%.1f\" }} requests/sec"

      # ----------------------------------------
      # Background Job Alerts
      # Warmup, cleanup, sticker refresh
      # ----------------------------------------
      - alert: WarmupJobSlow
        expr: |
          histogram_quantile(0.95, sum(rate(ntpu_job_duration_seconds_bucket{job="warmup",module="total"}[1h])) by (le)) > 1800
        for: 0m
        labels:
          severity: info
        annotations:
          summary: "Daily warmup job is taking longer than expected"
          description: "Warmup P95 duration is {{ $value | printf \"%.0f\" }}s (threshold: 30min)"

      - alert: CleanupJobSlow
        expr: |
          histogram_quantile(0.95, sum(rate(ntpu_job_duration_seconds_bucket{job="cleanup"}[1h])) by (le)) > 300
        for: 0m
        labels:
          severity: info
        annotations:
          summary: "Cache cleanup job is taking longer than expected"
          description: "Cleanup P95 duration is {{ $value | printf \"%.0f\" }}s (threshold: 5min)"

      # ----------------------------------------
      # Resource Alerts
      # Go runtime monitoring
      # ----------------------------------------
      - alert: HighMemoryUsage
        expr: |
          go_memstats_alloc_bytes{job="ntpu-linebot"} > 400 * 1024 * 1024
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanize1024 }}B (threshold: 400MB)"

      - alert: HighGoroutineCount
        expr: go_goroutines{job="ntpu-linebot"} > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High goroutine count"
          description: "Goroutine count is {{ $value }} (threshold: 1000)"

  # ============================================
  # Recording Rules
  # Pre-computed metrics for dashboard efficiency
  # ============================================
  - name: ntpu_recording_rules
    interval: 30s
    rules:
      # Webhook metrics
      - record: ntpu:webhook_success_rate:5m
        expr: |
          sum(rate(ntpu_webhook_total{status="success"}[5m]))
          /
          sum(rate(ntpu_webhook_total[5m]))

      - record: ntpu:webhook_latency_p50:5m
        expr: |
          histogram_quantile(0.5, sum(rate(ntpu_webhook_duration_seconds_bucket[5m])) by (le))

      - record: ntpu:webhook_latency_p95:5m
        expr: |
          histogram_quantile(0.95, sum(rate(ntpu_webhook_duration_seconds_bucket[5m])) by (le))

      - record: ntpu:webhook_latency_p99:5m
        expr: |
          histogram_quantile(0.99, sum(rate(ntpu_webhook_duration_seconds_bucket[5m])) by (le))

      # Cache metrics
      - record: ntpu:cache_hit_rate:5m
        expr: |
          sum(rate(ntpu_cache_operations_total{result="hit"}[5m])) by (module)
          /
          sum(rate(ntpu_cache_operations_total[5m])) by (module)

      - record: ntpu:cache_hit_rate_total:5m
        expr: |
          sum(rate(ntpu_cache_operations_total{result="hit"}[5m]))
          /
          sum(rate(ntpu_cache_operations_total[5m]))

      # Scraper metrics
      - record: ntpu:scraper_success_rate:5m
        expr: |
          sum(rate(ntpu_scraper_total{status="success"}[5m])) by (module)
          /
          sum(rate(ntpu_scraper_total[5m])) by (module)

      - record: ntpu:scraper_latency_p95:5m
        expr: |
          histogram_quantile(0.95, sum(rate(ntpu_scraper_duration_seconds_bucket[5m])) by (le, module))

      # LLM metrics
      - record: ntpu:llm_success_rate:5m
        expr: |
          sum(rate(ntpu_llm_total{status="success"}[5m])) by (operation)
          /
          sum(rate(ntpu_llm_total[5m])) by (operation)

      - record: ntpu:llm_latency_p95:5m
        expr: |
          histogram_quantile(0.95, sum(rate(ntpu_llm_duration_seconds_bucket[5m])) by (le, operation))

      # Search metrics
      - record: ntpu:search_success_rate:5m
        expr: |
          sum(rate(ntpu_search_total{status="success"}[5m])) by (type)
          /
          sum(rate(ntpu_search_total[5m])) by (type)

      - record: ntpu:search_latency_p95:5m
        expr: |
          histogram_quantile(0.95, sum(rate(ntpu_search_duration_seconds_bucket[5m])) by (le))

      # Request rate
      - record: ntpu:webhook_rps:5m
        expr: |
          sum(rate(ntpu_webhook_total[5m]))

      - record: ntpu:scraper_rps:5m
        expr: |
          sum(rate(ntpu_scraper_total[5m]))

      - record: ntpu:llm_rps:5m
        expr: |
          sum(rate(ntpu_llm_total[5m]))

      - record: ntpu:search_rps:5m
        expr: |
          sum(rate(ntpu_search_total[5m]))
