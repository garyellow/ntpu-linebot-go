# ID Module

å­¸è™ŸæŸ¥è©¢æ¨¡çµ„ - æä¾›å­¸ç”Ÿå­¸è™ŸæŸ¥è©¢ã€ç³»æ‰€ä»£ç¢¼æŸ¥è©¢ã€å­¸å¹´åº¦æŸ¥è©¢ç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ”¯æ´çš„æŸ¥è©¢æ–¹å¼

#### 1. **å§“åæŸ¥è©¢**
- **é—œéµå­—**ï¼š`å­¸è™Ÿ [å§“å]` / `student [name]`
- **æœå°‹ç­–ç•¥**ï¼šSQL character-set matching
  - ç‚ºæ¯å€‹å­—å…ƒç”Ÿæˆå‹•æ…‹ LIKE å­å¥
  - æ”¯æ´éé€£çºŒå­—å…ƒåŒ¹é…
  - ç¯„ä¾‹ï¼šã€Œç‹æ˜ã€å’Œã€Œæ˜ç‹ã€éƒ½èƒ½åŒ¹é…ã€Œç‹å°æ˜ã€
- **è¨˜æ†¶é«”æ•ˆç‡**ï¼šSQL-level filteringï¼Œä¸è¼‰å…¥å…¨è¡¨

#### 2. **ç³»æ‰€æŸ¥è©¢**
- **é—œéµå­—**ï¼š
  - ä»£ç¢¼ï¼š`ç³»ä»£ç¢¼ [ä»£ç¢¼]` / `dept [code]`ï¼ˆå¦‚ï¼š`ç³»ä»£ç¢¼ 85`ï¼‰
  - åç¨±ï¼š`ç³» [åç¨±]` / `department [name]`ï¼ˆå¦‚ï¼š`ç³» è³‡å·¥`ï¼‰
- **åŠŸèƒ½**ï¼šåˆ—å‡ºè©²ç³»æ‰€çš„æ‰€æœ‰å­¸ç”Ÿ
- **ç‰¹æ®Š**ï¼š`æ‰€æœ‰ç³»ä»£ç¢¼` - é¡¯ç¤ºå®Œæ•´çš„ç³»æ‰€ä»£ç¢¼å°ç…§è¡¨

#### 3. **å­¸å¹´åº¦æŸ¥è©¢**
- **é—œéµå­—**ï¼š`å­¸å¹´ [å¹´åº¦]` / `year [year]`
- **æ ¼å¼**ï¼š3 ä½æ•¸ ROC å¹´åº¦ï¼ˆå¦‚ï¼š`113`ï¼‰
- **åŠŸèƒ½**ï¼šåˆ—å‡ºè©²å­¸å¹´åº¦çš„æ‰€æœ‰å­¸ç”Ÿ

#### 4. **ç›´æ¥è¼¸å…¥å­¸è™Ÿ**
- **æ ¼å¼**ï¼š8-9 ä½æ•¸å­—ï¼ˆå¦‚ï¼š`412345678`ï¼‰
- **è™•ç†**ï¼šè‡ªå‹•è­˜åˆ¥ä¸¦æŸ¥è©¢è©²å­¸è™Ÿ

#### 5. **NLU è‡ªç„¶èªè¨€æŸ¥è©¢**ï¼ˆéœ€è¦ LLM API Keyï¼‰
- **Intent Functions**ï¼š
  - `id_search` - å§“åæŸ¥è©¢
  - `id_student_id` - å­¸è™ŸæŸ¥è©¢
  - `id_department` - ç³»æ‰€æŸ¥è©¢
- **ç¯„ä¾‹**ï¼šã€Œç‹å°æ˜çš„å­¸è™Ÿã€ã€ã€Œ412345678 æ˜¯èª°ã€ã€ã€Œè³‡å·¥ç³»æœ‰èª°ã€

## æ¶æ§‹è¨­è¨ˆ

### Handler çµæ§‹

```go
type Handler struct {
    db             *storage.DB
    scraper        *scraper.Client
    metrics        *metrics.Metrics
    logger         *logger.Logger
    stickerManager *sticker.Manager
}
```

### è³‡æ–™æ¨¡å‹

#### Student çµæ§‹
```go
type Student struct {
    ID         string  // å­¸è™Ÿï¼ˆ8-9 ä½æ•¸å­—ï¼‰
    Name       string  // å§“å
    Year       int     // å…¥å­¸å¹´åº¦ï¼ˆROCï¼‰
    Department string  // ç³»æ‰€ä»£ç¢¼
    CachedAt   int64   // å¿«å–æ™‚é–“
}
```

#### ç³»æ‰€ä»£ç¢¼æ˜ å°„
```go
// DepartmentCodeToName (data/departments.go)
// å°‡ç³»æ‰€ä»£ç¢¼æ˜ å°„åˆ°ç³»æ‰€å…¨å
// ç¯„ä¾‹ï¼š85 â†’ è³‡è¨Šå·¥ç¨‹å­¸ç³»
```

### æœå°‹ç­–ç•¥

#### SQL Character-Set Matching

```go
// ç‚ºæ¯å€‹å­—å…ƒç”Ÿæˆ LIKE å­å¥
// ç¯„ä¾‹ï¼šSearchStudentsByName("ç‹æ˜")
// â†’ WHERE name LIKE '%ç‹%' AND name LIKE '%æ˜%'

// å„ªé»ï¼š
// 1. æ”¯æ´éé€£çºŒåŒ¹é…ï¼ˆã€Œç‹æ˜ã€èƒ½æ‰¾åˆ°ã€Œç‹å°æ˜ã€ï¼‰
// 2. SQL-level filteringï¼ˆmemory efficientï¼‰
// 3. ä¸éœ€è¦è¼‰å…¥å…¨è¡¨
```

#### çµæœé™åˆ¶
```go
const MaxStudentsPerSearch = 400

// é¡¯ç¤ºé‚è¼¯ï¼š
// - å¦‚æœçµæœ > 400ï¼Œé¡¯ç¤ºå‰ 400 ç­†
// - é™„åŠ è­¦å‘Šè¨Šæ¯ï¼šã€Œæ‰¾åˆ° X ç­†ï¼Œé¡¯ç¤ºå‰ 400 ç­†ã€
```

### å¿«å–ç­–ç•¥

> å®Œæ•´çš„å¿«å–ç­–ç•¥èªªæ˜è«‹åƒè€ƒ [æ¶æ§‹èªªæ˜æ–‡ä»¶](/.github/copilot-instructions.md#data-layer-cache-first-strategy)

**å­¸ç”Ÿè³‡æ–™ç‰¹æ€§**ï¼š
- **TTL**ï¼šæ°¸ä¸éæœŸï¼ˆéœæ…‹è³‡æ–™ï¼Œä¸æœƒæ›´æ–°ï¼‰
- **Cache ç¯„åœ**ï¼š101-112 å­¸å¹´åº¦ï¼ˆå•Ÿå‹•æ™‚è‡ªå‹•è¼‰å…¥ï¼Œå®Œæ•´è³‡æ–™ï¼‰
- **Query ç¯„åœ**ï¼š94-112 å­¸å¹´åº¦ï¼ˆcache miss æ™‚å³æ™‚çˆ¬å–ï¼Œå®Œæ•´è³‡æ–™ï¼‰
- **113 å­¸å¹´åº¦**ï¼šè³‡æ–™ä¸å®Œæ•´ï¼Œåƒ…æ¥µå°‘æ•¸å­¸ç”Ÿï¼ˆå…è¨±æŸ¥è©¢ä½†é¡¯ç¤ºè­¦å‘Šï¼‰
- **è³‡æ–™ç‹€æ…‹**ï¼š114 å­¸å¹´åº¦èµ·ç„¡æ–°è³‡æ–™ï¼ˆæ•¸ä½å­¸è‹‘ 2.0 åœç”¨ï¼‰

## Flex Message è¨­è¨ˆ

### å­¸ç”Ÿè¼ªæ’­ï¼ˆStudent Carouselï¼‰
- **Colored Header**ï¼ˆç´«è‰²ï¼‰ï¼šå­¸ç”Ÿå§“å
- **Body**ï¼š
  - ç¬¬ä¸€åˆ—ï¼šğŸ“ åœ‹ç«‹è‡ºåŒ—å¤§å­¸ æ¨™ç±¤ï¼ˆç´«è‰²ï¼‰
  - å­¸è™Ÿã€å…¥å­¸å¹´åº¦ã€æ¨æ¸¬ç³»æ‰€
  - **è³‡æ–™èªªæ˜**ï¼šç³»æ‰€ç”±å­¸è™Ÿæ¨æ¸¬ï¼Œå¯èƒ½ä¸æº–ç¢ºï¼ˆè½‰ç³»ç­‰æƒ…æ³ï¼‰
- **Footer**ï¼š
  - ã€Œè¤‡è£½å­¸è™Ÿã€æŒ‰éˆ•ï¼ˆç¶ è‰²ï¼Œè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼‰

### ç³»æ‰€ä»£ç¢¼åˆ—è¡¨ï¼ˆDepartment Code Listï¼‰
- **Buttons Template**ï¼šå®Œæ•´çš„ç³»æ‰€ä»£ç¢¼å°ç…§è¡¨
- **æ ¼å¼**ï¼šä»£ç¢¼ - ç³»æ‰€å…¨å
- **ç”¨é€”**ï¼šè®“ä½¿ç”¨è€…äº†è§£å¦‚ä½•æŸ¥è©¢ç‰¹å®šç³»æ‰€

### æœå°‹çµæœæ‘˜è¦
- **è­¦å‘Šè¨Šæ¯**ï¼ˆå¦‚çµæœ > 400ï¼‰ï¼š
  ```
  âš ï¸ æœå°‹çµæœéå¤š
  æ‰¾åˆ° X ç­†çµæœï¼Œåƒ…é¡¯ç¤ºå‰ 400 ç­†
  è«‹ä½¿ç”¨æ›´å…·é«”çš„æŸ¥è©¢æ¢ä»¶
  ```

### Quick Reply
- ä½¿ç”¨ `QuickReplyStudentNav()`
- åŒ…å«ï¼šğŸ“ å­¸è™Ÿã€ğŸ“… å­¸å¹´ã€ğŸ“‹ ç³»ä»£ç¢¼ã€ğŸ“– èªªæ˜

## æœå°‹æµç¨‹

### å§“åæŸ¥è©¢æµç¨‹
```
User Input: "å­¸è™Ÿ ç‹æ˜"
    â†“
Extract name: "ç‹æ˜"
    â†“
SQL Character-Set Matching
WHERE name LIKE '%ç‹%' AND name LIKE '%æ˜%'
    â†“
Load results (limit 400)
    â†“
Parse department from student ID
    â†“
Build Student Carousel
    â†“ (if > 400)
Add warning message
```

### å­¸è™ŸæŸ¥è©¢æµç¨‹
```
User Input: "412345678"
    â†“
Validate format (8-9 digits)
    â†“
Check cache (101-112)
    â†“ (if miss)
Scrape from LMS (94-112 å®Œæ•´, 113 ä¸å®Œæ•´)
    â†“ (if found)
Save to cache
    â†“
Build Student Detail
```

### ç³»æ‰€æŸ¥è©¢æµç¨‹
```
User Input: "ç³» è³‡å·¥" or "ç³»ä»£ç¢¼ 85"
    â†“
Resolve to department code (85)
    â†“
GetStudentsByDepartment(85)
    â†“
Build Student Carousel
    â†“ (if > 400)
Truncate + warning
```

## å­¸è™Ÿè§£æ

### å­¸è™Ÿæ ¼å¼
```
[å…¥å­¸å¹´åº¦][ç³»æ‰€ä»£ç¢¼][æµæ°´è™Ÿ]
     4          2        2-3 digits

ç¯„ä¾‹ï¼š
- 412345678 (9 digits)
  - å…¥å­¸å¹´åº¦ï¼š41 (101 å­¸å¹´åº¦)
  - ç³»æ‰€ä»£ç¢¼ï¼š23
  - æµæ°´è™Ÿï¼š45678

- 41234567 (8 digits)
  - å…¥å­¸å¹´åº¦ï¼š41 (101 å­¸å¹´åº¦)
  - ç³»æ‰€ä»£ç¢¼ï¼š23
  - æµæ°´è™Ÿï¼š4567
```

### ç³»æ‰€æ¨æ¸¬
```go
// å¾å­¸è™Ÿæå–ç³»æ‰€ä»£ç¢¼
deptCode := studentID[4:6]  // ç¬¬ 5-6 ä½æ•¸å­—

// æ˜ å°„åˆ°ç³»æ‰€åç¨±
deptName := data.DepartmentCodeToName[deptCode]
// å¦‚æœæ‰¾ä¸åˆ° â†’ "æœªçŸ¥ç³»æ‰€"
```

### æ³¨æ„äº‹é …
- **æ¨æ¸¬æ€§è³ª**ï¼šç³»æ‰€è³‡è¨Šç”±å­¸è™Ÿæ¨æ¸¬ï¼Œéå®˜æ–¹è³‡æ–™
- **è½‰ç³»æƒ…æ³**ï¼šè½‰ç³»å­¸ç”Ÿçš„ç³»æ‰€å¯èƒ½ä¸æº–ç¢º
- **è³‡æ–™èªªæ˜**ï¼šFlex Message åº•éƒ¨æœƒè¨»æ˜æ­¤é™åˆ¶

## æ¸¬è©¦è¦†è“‹

### å–®å…ƒæ¸¬è©¦
- Keyword matching æ¸¬è©¦
- Student ID parsing æ¸¬è©¦
- Department code resolution æ¸¬è©¦
- Search result formatting æ¸¬è©¦

### æ•´åˆæ¸¬è©¦ï¼ˆ`-short` flag è·³éï¼‰
- Database queries
- Scraper integration
- Cache behavior

## æ•ˆèƒ½è€ƒé‡

### æœå°‹å„ªåŒ–
- **SQL ç´¢å¼•**ï¼šname, year, department
- **Character-set matching**ï¼šSQL-level filtering
- **çµæœé™åˆ¶**ï¼š400 ç­†é¿å…è¨Šæ¯éè¼‰

### Memory ä½¿ç”¨
- **éœæ…‹è³‡æ–™**ï¼š101-112 å­¸å¹´åº¦å¸¸é§å¿«å–ï¼ˆ~50MBï¼Œå®Œæ•´è³‡æ–™ï¼‰
- **113 å­¸å¹´åº¦**ï¼šè³‡æ–™ä¸å®Œæ•´ï¼Œåƒ…æ¥µå°‘æ•¸å­¸ç”Ÿ
- **ä¸æœƒå¢é•·**ï¼š114 èµ·ç„¡æ–°è³‡æ–™
- **å¿«é€ŸæŸ¥è©¢**ï¼šç„¡éœ€ç¶²è·¯è«‹æ±‚ï¼ˆcache hitï¼‰

## é™åˆ¶èˆ‡æ³¨æ„äº‹é …

### è³‡æ–™ç¯„åœ
- **Cache**ï¼š101-112 å­¸å¹´åº¦ï¼ˆè‡ªå‹•é è¼‰ï¼Œå®Œæ•´è³‡æ–™ï¼‰
- **Query**ï¼š94-112 å­¸å¹´åº¦ï¼ˆreal-time scrapingï¼Œå®Œæ•´è³‡æ–™ï¼‰
- **Year 113**ï¼šå…è¨±æŸ¥è©¢ä½†è³‡æ–™ä¸å®Œæ•´ï¼ˆåƒ…æ¥µå°‘æ•¸å­¸ç”Ÿæœ‰æ•¸ä½å­¸è‹‘ 2.0 å¸³è™Ÿï¼‰
  - å­¸å¹´åº¦æŸ¥è©¢ï¼šé¡¯ç¤ºè­¦å‘Šè¨Šæ¯ï¼Œæä¾›ã€Œç¹¼çºŒæŸ¥è©¢ã€æŒ‰éˆ•
  - å€‹äººå­¸è™ŸæŸ¥è©¢ï¼šæœ‰è³‡æ–™æ­£å¸¸é¡¯ç¤ºï¼ˆä¸è­¦å‘Šï¼‰ï¼Œç„¡è³‡æ–™é¡¯ç¤ºç‰¹åˆ¥èªªæ˜
- **Year 114+**ï¼šæ•¸ä½å­¸è‹‘ 2.0 åœç”¨ï¼Œç„¡è³‡æ–™
  - å­¸å¹´åº¦æŸ¥è©¢ï¼šRIP åœ–ç‰‡ + æ‹’çµ•è¨Šæ¯
  - å€‹äººå­¸è™ŸæŸ¥è©¢ï¼šæå‰æ‹’çµ•ï¼ˆä¸æŸ¥è©¢è³‡æ–™åº«ï¼‰

### è³‡æ–™æº–ç¢ºæ€§
- **ç³»æ‰€æ¨æ¸¬**ï¼šå¾å­¸è™Ÿæ¨æ¸¬ï¼Œå¯èƒ½ä¸æº–ç¢º
- **è½‰ç³»æƒ…æ³**ï¼šç„¡æ³•åµæ¸¬è½‰ç³»
- **è³‡æ–™ä¾†æº**ï¼šLMS 1.0ï¼ˆå¯èƒ½éæ™‚ï¼‰

### éš±ç§è€ƒé‡
- **å…¬é–‹è³‡è¨Š**ï¼šåƒ…é¡¯ç¤ºå­¸è™Ÿå’Œå§“åï¼ˆå­¸æ ¡å…¬é–‹è³‡æ–™ï¼‰
- **ç„¡æ•æ„Ÿè³‡è¨Š**ï¼šä¸å­˜å„²å€‹äººè¯çµ¡æ–¹å¼
- **è³‡æ–™ç”¨é€”**ï¼šåƒ…ä¾›æ ¡å…§æŸ¥è©¢

## ç›¸é—œæ–‡ä»¶
- Handler: `internal/modules/id/handler.go`
- Tests: `internal/modules/id/handler_test.go`
- Storage: `internal/storage/student.go`
- Scraper: `internal/scraper/ntpu/student.go`
- Department Data: `internal/data/programs.go`

## ä¾è³´é—œä¿‚
- `storage.DB` - å­¸ç”Ÿè³‡æ–™æŸ¥è©¢
- `scraper.Client` - å³æ™‚æŠ“å–ï¼ˆ94-100 å­¸å¹´åº¦ï¼‰
- `data.DepartmentCodeToName` - ç³»æ‰€ä»£ç¢¼æ˜ å°„
- `metrics.Metrics` - ç›£æ§æŒ‡æ¨™
- `logger.Logger` - æ—¥èªŒè¨˜éŒ„
- `sticker.Manager` - Sender é ­åƒ
