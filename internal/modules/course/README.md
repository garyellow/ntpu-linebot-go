# Course Module

èª²ç¨‹æŸ¥è©¢æ¨¡çµ„ - æä¾›å¤šç¨®èª²ç¨‹æœå°‹æ–¹å¼ï¼ŒåŒ…æ‹¬ç²¾ç¢ºæœå°‹ã€æ™ºæ…§æœå°‹ã€èª²è™ŸæŸ¥è©¢ç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

### æ”¯æ´çš„æŸ¥è©¢æ–¹å¼

#### 1. **ç²¾ç¢ºæœå°‹**ï¼ˆæœ€è¿‘ 2 å­¸æœŸï¼‰
- **é—œéµå­—**ï¼š`èª²ç¨‹ [é—œéµå­—]` / `è€å¸« [æ•™å¸«å]`
- **SQL LIKE æœå°‹** + **æ¨¡ç³Šæœå°‹**ï¼ˆ2-tier searchï¼‰
- **ç¯„åœ**ï¼šæœ€è¿‘ 2 å€‹å­¸æœŸï¼ˆsemester 1-2ï¼‰
- **æ’åº**ï¼šæœ€æ–°å­¸æœŸå„ªå…ˆ

#### 2. **æ“´å±•æœå°‹**ï¼ˆæ­·å²å­¸æœŸï¼‰
- **é—œéµå­—**ï¼š`æ›´å¤šå­¸æœŸ [é—œéµå­—]`
- **ç¯„åœ**ï¼šæ¥ä¸‹ä¾† 2 å€‹æ­·å²å­¸æœŸï¼ˆsemester 3-4ï¼‰
- **ä½¿ç”¨æƒ…å¢ƒ**ï¼šç²¾ç¢ºæœå°‹ç„¡çµæœæ™‚çš„å»¶ä¼¸æŸ¥è©¢
- **Quick Reply**ï¼šğŸ“… æ›´å¤š æŒ‰éˆ•ï¼ˆcompact displayï¼‰

#### 3. **æ™ºæ…§æœå°‹**ï¼ˆBM25 + Query Expansionï¼‰
- **é—œéµå­—**ï¼š`æ‰¾èª² [æè¿°]`
- **æŠ€è¡“**ï¼šBM25 ç´¢å¼• + LLM Query Expansion
- **ç‰¹è‰²**ï¼š
  - èªæ„æœå°‹ï¼ˆç†è§£è‡ªç„¶èªè¨€éœ€æ±‚ï¼‰
  - ç›¸é—œæ€§è©•åˆ†ï¼ˆ0-1ï¼Œé¦–ç­†æ°¸é  1.0ï¼‰
  - ä¸­æ–‡åˆ†è©ï¼ˆunigram tokenizationï¼‰
  - æ”¯æ´ç¸®å¯«å’Œå°ˆæ¥­è¡“èª
- **ç¯„ä¾‹**ï¼šã€Œæ‰¾èª² ç·šä¸Šå¯¦é«”æ··åˆã€ã€ã€Œæ‰¾èª² AI æ©Ÿå™¨å­¸ç¿’ã€

#### 4. **èª²è™ŸæŸ¥è©¢**
- **æ ¼å¼**ï¼š
  - å®Œæ•´ UIDï¼š`1131U0001`ï¼ˆå¹´åº¦+å­¸æœŸ+èª²è™Ÿï¼‰
  - èª²è™Ÿï¼š`U0001`ï¼ˆè‡ªå‹•æœå°‹æœ€è¿‘å­¸æœŸï¼‰
- **å›æ‡‰**ï¼šèª²ç¨‹è©³æƒ… Flex Message
- **é¡å¤–è³‡è¨Š**ï¼šèª²ç¨‹å¤§ç¶±ã€ç›¸é—œå­¸ç¨‹

#### 5. **NLU è‡ªç„¶èªè¨€æŸ¥è©¢**ï¼ˆéœ€è¦ LLM API Keyï¼‰
- **Intent Functions**ï¼š
  - `course_search` - ç²¾ç¢ºæœå°‹ï¼ˆèª²å/æ•™å¸«ï¼‰
  - `course_smart` - æ™ºæ…§æœå°‹ï¼ˆèªæ„éœ€æ±‚ï¼‰
  - `course_uid` - èª²è™ŸæŸ¥è©¢
- **ç¯„ä¾‹**ï¼šã€Œå¾®ç©åˆ†çš„èª²æœ‰å“ªäº›ã€ã€ã€Œæƒ³å­¸ AIã€ã€ã€ŒU0001 æ˜¯ä»€éº¼èª²ã€

### æœå°‹é™åˆ¶
- **æœ€å¤§çµæœæ•¸**ï¼š40 ç­†ï¼ˆ`MaxCoursesPerSearch`ï¼‰
  - 4 å€‹è¼ªæ’­ï¼ˆcarouselï¼‰Ã— 10 å€‹æ³¡æ³¡ï¼ˆbubblesï¼‰
  - é ç•™ 1 å€‹è¨Šæ¯ä½ç½®çµ¦è­¦å‘Šè¨Šæ¯
  - LINE API é™åˆ¶ï¼šæœ€å¤š 5 å€‹è¨Šæ¯/å›æ‡‰

## æ¶æ§‹è¨­è¨ˆ

### Pattern-Action Table

ä½¿ç”¨ **Pattern-Action Table** æ¶æ§‹ç¢ºä¿ `CanHandle()` å’Œ `HandleMessage()` çš„è·¯ç”±ä¸€è‡´æ€§ï¼š

```go
type PatternMatcher struct {
    pattern  *regexp.Regexp
    priority int            // å„ªå…ˆç´šï¼ˆè¶Šå°è¶Šå„ªå…ˆï¼‰
    handler  PatternHandler // è™•ç†å‡½æ•¸
    name     string         // ç”¨æ–¼æ—¥èªŒ
}
```

**å„ªå…ˆç´šé †åº**ï¼ˆ1=æœ€é«˜ï¼‰ï¼š
1. **UID** - å®Œæ•´ UID (e.g., `1131U0001`)
2. **CourseNo** - èª²è™Ÿ (e.g., `U0001`)
3. **Historical** - æ­·å²æŸ¥è©¢ (`èª²ç¨‹ 110 å¾®ç©åˆ†`)
4. **Smart** - æ™ºæ…§æœå°‹ (`æ‰¾èª²`)
5. **Extended** - æ“´å±•æœå°‹ (`æ›´å¤šå­¸æœŸ`)
6. **Regular** - ç²¾ç¢ºæœå°‹ (`èª²ç¨‹`/`è€å¸«`)

### æ ¸å¿ƒçµ„ä»¶

#### Handler çµæ§‹
```go
type Handler struct {
    db               *storage.DB
    scraper          *scraper.Client
    metrics          *metrics.Metrics
    logger           *logger.Logger
    stickerManager   *sticker.Manager
    bm25Index        *rag.BM25Index           // æ™ºæ…§æœå°‹
    queryExpander    genai.QueryExpander      // LLM Query Expansion
    llmRateLimiter   *ratelimit.KeyedLimiter  // LLM é¡åº¦æ§åˆ¶
    semesterDetector *SemesterDetector        // è³‡æ–™é©…å‹•å­¸æœŸåµæ¸¬
    matchers         []PatternMatcher         // Pattern-Action Table
}
```

#### SemesterDetector
- **è³‡æ–™é©…å‹•è¨­è¨ˆ**ï¼šå¾è³‡æ–™åº«å‹•æ…‹è¼‰å…¥å¯ç”¨å­¸æœŸ
- **æ–¹æ³•**ï¼š
  - `GetRecentSemesters(count)` - å–å¾—æœ€è¿‘ N å€‹å­¸æœŸ
  - `GetHistoricalSemesters(skip, count)` - å–å¾—æ­·å²å­¸æœŸ
  - `Refresh()` - é‡æ–°è¼‰å…¥å¯ç”¨å­¸æœŸï¼ˆwarmup å¾Œï¼‰
- **ä½¿ç”¨æƒ…å¢ƒ**ï¼š
  - ç²¾ç¢ºæœå°‹ï¼š`GetRecentSemesters(2)` â†’ 1-2
  - æ“´å±•æœå°‹ï¼š`GetHistoricalSemesters(2, 2)` â†’ 3-4
  - é¿å…ç¡¬ç·¨ç¢¼å­¸æœŸç¯„åœ

### æœå°‹ç­–ç•¥

#### 2-Tier Searchï¼ˆç²¾ç¢º/æ“´å±•æœå°‹ï¼‰
1. **SQL LIKE**ï¼š`WHERE title LIKE ? OR teachers LIKE ?`
2. **SQL Fuzzy**ï¼š`ContainsAllRunes()` - å­—å…ƒé›†åˆåŒ¹é…ï¼ˆéé€£çºŒï¼‰
3. **æ’åº**ï¼šå­¸æœŸç”±æ–°åˆ°èˆŠï¼ˆsemester_sort_keyï¼‰

#### Smart Searchï¼ˆæ™ºæ…§æœå°‹ï¼‰
1. **Query Expansion**ï¼šLLM æ“´å±•åŸå§‹æŸ¥è©¢
   - æ·»åŠ åŒç¾©è©ã€ç›¸é—œè¡“èª
   - è™•ç†ç¸®å¯«å’Œå°ˆæ¥­è©å½™
2. **BM25 æœå°‹**ï¼šèªæ„ç›¸ä¼¼åº¦æ’åº
   - k1=1.5, b=0.75ï¼ˆBM25 åƒæ•¸ï¼‰
   - ä¸­æ–‡ unigram tokenization
3. **ç›¸é—œæ€§æ¨™ç±¤**ï¼š
   - ğŸ¯ æœ€ä½³åŒ¹é…ï¼ˆæ·±é’ç¶ ï¼‰- é¦–ç­†æ°¸é  1.0
   - âœ¨ é«˜åº¦ç›¸é—œï¼ˆé’ç¶ ï¼‰- ç›¸å°åˆ†æ•¸ > 0.6
   - ğŸ“‹ éƒ¨åˆ†ç›¸é—œï¼ˆç¿ ç¶ ï¼‰- å…¶ä»–

## Flex Message è¨­è¨ˆ

### è¼ªæ’­å¡ç‰‡ï¼ˆCourse Carouselï¼‰
- **Colored Header**ï¼šå­¸æœŸ/ç›¸é—œæ€§æ¨™ç±¤
  - è—è‰²ç³»æ¼¸å±¤ï¼šæœ€æ–°å­¸æœŸï¼ˆæ˜äº®è—ï¼‰â†’ ä¸Šå­¸æœŸï¼ˆé’ï¼‰â†’ éå»å­¸æœŸï¼ˆç°ï¼‰
  - é’ç¶ è‰²æ¼¸å±¤ï¼šæœ€ä½³åŒ¹é…ï¼ˆæ·±é’ç¶ ï¼‰â†’ é«˜åº¦ç›¸é—œï¼ˆé’ç¶ ï¼‰â†’ éƒ¨åˆ†ç›¸é—œï¼ˆç¿ ç¶ ï¼‰
- **Body**ï¼š
  - ç¬¬ä¸€åˆ—ï¼š`NewBodyLabel()` å­¸æœŸ/ç›¸é—œæ€§æ¨™ç±¤ï¼ˆæ–‡å­—è‰²èˆ‡ header ä¸€è‡´ï¼‰
  - èª²ç¨‹è³‡è¨Šï¼šèª²è™Ÿã€æ•™å¸«ã€æ™‚é–“ã€åœ°é»
  - æ–‡å­—é è¨­ä¸æ›è¡Œï¼ˆç·Šæ¹Šé¡¯ç¤ºï¼‰
- **Footer**ï¼š
  - ã€ŒæŸ¥çœ‹è©³ç´°ã€æŒ‰éˆ•ï¼ˆé¡è‰²èˆ‡ header åŒæ­¥ï¼‰

### è©³æƒ…é ï¼ˆCourse Detailï¼‰
- **Colored Header**ï¼ˆè—è‰²ï¼‰ï¼šèª²ç¨‹åç¨±
- **Body**ï¼š
  - ç¬¬ä¸€åˆ—ï¼šğŸ“š èª²ç¨‹è³‡è¨Š æ¨™ç±¤ï¼ˆæ˜äº®è—è‰²ï¼‰
  - å®Œæ•´è³‡è¨Šï¼šèª²è™Ÿã€å­¸æœŸã€æ•™å¸«ã€å¿…é¸ä¿®ã€å­¸åˆ†ã€æ™‚é–“ã€åœ°é»ã€å‚™è¨»
  - æ–‡å­—ä½¿ç”¨ `wrap: true` å®Œæ•´é¡¯ç¤º
- **Footer**ï¼š
  - èª²ç¨‹å¤§ç¶±æŒ‰éˆ•ï¼ˆå¤–éƒ¨é€£çµï¼‰
  - æ•™å¸«èª²ç¨‹æŒ‰éˆ•ï¼ˆå…§éƒ¨ Postbackï¼‰
  - ç›¸é—œå­¸ç¨‹æŒ‰éˆ•ï¼ˆå¦‚æœ‰ï¼‰

### Quick Reply
- ä½¿ç”¨ `QuickReplyCourseNav(smartSearchEnabled)`
- åŒ…å«ï¼šğŸ“š èª²ç¨‹ã€ğŸ”® æ‰¾èª²ï¼ˆæ™ºæ…§æœå°‹ï¼‰ã€ğŸ“– èªªæ˜

## è³‡æ–™æµç¨‹

### æŸ¥è©¢æµç¨‹
```
User Input
    â†“
Pattern Matching (priority order)
    â†“
â”Œâ”€ Regular/Extended â”€â”   â”Œâ”€ Smart Search â”€â”   â”Œâ”€ UID/CourseNo â”€â”
â”‚ GetRecentSemestersâ”‚   â”‚ Query Expansionâ”‚   â”‚ Parse UID      â”‚
â”‚ SQL LIKE + Fuzzy  â”‚   â”‚ BM25 Search    â”‚   â”‚ GetCourse()    â”‚
â”‚ Sort by semester  â”‚   â”‚ Score + Label  â”‚   â”‚ Detail Flex    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“                       â†“                       â†“
Carousel (max 40)       Carousel + Score        Single Bubble
```

### Cache ç­–ç•¥

> å®Œæ•´çš„å¿«å–ç­–ç•¥èªªæ˜è«‹åƒè€ƒ [æ¶æ§‹èªªæ˜æ–‡ä»¶](/.github/copilot-instructions.md#data-layer-cache-first-strategy)

- **TTL**ï¼š7 å¤©ï¼ˆæ¯æ—¥ 3:00 AM è‡ªå‹•æ›´æ–°ï¼‰
- **ç¯„åœ**ï¼šæœ€è¿‘ 4 å€‹å­¸æœŸçš„èª²ç¨‹è³‡æ–™

### Syllabus æ•´åˆ
- **æ›´æ–°æ™‚æ©Ÿ**ï¼šWarmup onlyï¼ˆéå³æ™‚æŸ¥è©¢ï¼Œåƒ…æœ€è¿‘ 2 å€‹å­¸æœŸï¼‰
- **ç¯„åœ**ï¼šæœ€è¿‘ 2 å€‹æœ‰è³‡æ–™çš„å­¸æœŸ
- **ç”¨é€”**ï¼šæ™ºæ…§æœå°‹çš„èªæ„ç´¢å¼•

## æ¸¬è©¦è¦†è“‹

### å–®å…ƒæ¸¬è©¦
- Pattern matching æ¸¬è©¦
- Semester detection æ¸¬è©¦
- UID parsing æ¸¬è©¦
- Search result formatting æ¸¬è©¦

### æ•´åˆæ¸¬è©¦ï¼ˆ`-short` flag è·³éï¼‰
- Database integration
- Scraper integration
- BM25 search

## æ•ˆèƒ½è€ƒé‡

### æœå°‹å„ªåŒ–
- **SQL ç´¢å¼•**ï¼šyear, term, title, teachers
- **BM25 in-memory**ï¼šé¿å…æ¯æ¬¡é‡å»ºç´¢å¼•
- **Rate limiting**ï¼šLLM API èª¿ç”¨é™åˆ¶
- **çµæœæˆªæ–·**ï¼šæœ€å¤š 40 ç­†é¿å…è¨Šæ¯éè¼‰

### Memory ç®¡ç†
- BM25 ç´¢å¼•ï¼š~10-20MBï¼ˆå–æ±ºæ–¼èª²ç¨‹æ•¸é‡ï¼‰
- Query Expansionï¼šæ¯æ¬¡èª¿ç”¨ ~1KB
- çµæœé›†ï¼šé™åˆ¶ 40 ç­†é¿å…éåº¦æ¶ˆè€—

## ç›¸é—œæ–‡ä»¶
- Handler: `internal/modules/course/handler.go`
- Semester: `internal/modules/course/semester.go`
- Tests: `internal/modules/course/handler_test.go`
- BM25: `internal/rag/bm25.go`
- Syllabus: `internal/syllabus/scraper.go`
- Query Expansion: `internal/genai/`

## ä¾è³´é—œä¿‚
- `storage.DB` - èª²ç¨‹è³‡æ–™æŸ¥è©¢
- `scraper.Client` - å³æ™‚æŠ“å–
- `rag.BM25Index` - æ™ºæ…§æœå°‹ï¼ˆå¯é¸ï¼‰
- `genai.QueryExpander` - æŸ¥è©¢æ“´å±•ï¼ˆå¯é¸ï¼‰
- `ratelimit.KeyedLimiter` - LLM é¡åº¦æ§åˆ¶ï¼ˆå¯é¸ï¼‰
