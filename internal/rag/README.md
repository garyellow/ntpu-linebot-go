# rag

Retrieval-Augmented Generation (RAG) æ¨¡çµ„ï¼Œæä¾›èª²ç¨‹èªæ„æœå°‹åŠŸèƒ½ã€‚

## åŠŸèƒ½

- **BM25Index**: BM25 é—œéµå­—æœå°‹ç´¢å¼• (ä¸­æ–‡åˆ†è©å„ªåŒ–)
- **Query Expansion**: LLM æ“´å±•æŸ¥è©¢è©å½™ï¼ˆåŒç¾©è©ã€ç¸®å¯«ã€ç¿»è­¯ï¼‰
- **Rank-based Confidence**: åŸºæ–¼æ’åçš„ä¿¡å¿ƒåˆ†æ•¸

## æ¶æ§‹

```
Search Flow:
  ä½¿ç”¨è€…æŸ¥è©¢ â†’ Query Expansion (LLM æ“´å±•)
      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ BM25 Search (expanded keywords)  â”‚
  â”‚ - ä¸­æ–‡ Bigram åˆ†è©              â”‚
  â”‚ - IDF åŠ æ¬Š                       â”‚
  â”‚ - æ’åä¿¡å¿ƒåˆ†æ•¸                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“
  å»é‡åˆä½µ â†’ æ’åºçµæœ
```

## ç‚ºä»€éº¼ä¸ç”¨ Embeddingï¼Ÿ


| è€ƒé‡ | BM25 + Query Expansion | Embedding (Vector) |
|------|------------------------|-------------------|
| **å°å‹èªæ–™åº« (<10K)** | âœ… è¶³å¤ æœ‰æ•ˆ | éåº¦è¨­è¨ˆ |
| **ç²¾ç¢ºé—œéµå­—åŒ¹é…** | âœ… åŸç”Ÿæ”¯æ´ | éœ€è¦èª¿æ•´ |
| **API æˆæœ¬** | âœ… åƒ…æŸ¥è©¢æ“´å±• | æ¯æ¬¡æŸ¥è©¢éƒ½éœ€ API |
| **å»¶é²** | âœ… <10ms | 100-500ms |
| **ç¸®å¯«/åŒç¾©è©** | âœ… é€é Query Expansion | èªæ„åŒ¹é…ä½†ä¸ç²¾ç¢º |
| **è¤‡é›œåº¦** | âœ… ç°¡å–®æ˜“ç¶­è­· | éœ€è¦å‘é‡è³‡æ–™åº« |

**çµè«–**: å°æ–¼ ~2000 é–€èª²ç¨‹çš„èªæ–™åº«ï¼ŒBM25 + Query Expansion å·²è¶³å¤ ï¼ŒEmbedding æ˜¯éåº¦å·¥ç¨‹ã€‚

## ç›¸é—œåº¦é¡¯ç¤º

### è¨­è¨ˆåŸå‰‡ (2025 UX æœ€ä½³å¯¦è¸)

BM25 è¼¸å‡ºç„¡ç•Œåˆ†æ•¸ï¼Œä¸åŒæŸ¥è©¢é–“ç„¡æ³•æ¯”è¼ƒã€‚åŸºæ–¼ chatbot UX ç ”ç©¶ï¼Œæˆ‘å€‘æ¡ç”¨**ç°¡åŒ–å…©å±¤åˆ¶**ï¼š

| æ’å | é¡¯ç¤ºæ¨™ç±¤ | è¨­è¨ˆç†ç”± |
|------|----------|----------|
| #1-3 | ğŸ¯ æœ€ç›¸é—œ | å‰ä¸‰åï¼Œé«˜ä¿¡å¿ƒæ¨è–¦ |
| #4+ | âœ¨ ç›¸é—œ | å¾ŒçºŒçµæœï¼Œä»ç¬¦åˆæŸ¥è©¢ |

**ç‚ºä»€éº¼é€™æ¨£è¨­è¨ˆï¼Ÿ**

1. **ç§»é™¤ç™¾åˆ†æ¯”**ï¼šä½¿ç”¨è€…ç„¡æ³•è·¨æŸ¥è©¢æ¯”è¼ƒæ•¸å­—ï¼Œç™¾åˆ†æ¯”é€ æˆè™›å‡ç²¾ç¢ºæ„Ÿ
2. **ç°¡åŒ–åˆ†é¡**ï¼š4 å±¤è®Š 2 å±¤ï¼Œé™ä½èªçŸ¥è² æ“”
3. **åŸºæ–¼æ’å**ï¼šã€Œå‰ä¸‰åã€æ¯”ã€Œ80% ä¿¡å¿ƒã€æ›´ç›´è§€
4. **å¼•å°æ”¹é€²**ï¼šçµæœå°‘æ™‚æç¤ºä½¿ç”¨æ›´å…·é«”é—œéµå­—

### å…§éƒ¨è¨ˆç®— (ä¿ç•™ä¾›åƒè€ƒ)

```go
// å…§éƒ¨ä¿¡å¿ƒåˆ†æ•¸è¨ˆç®—ï¼ˆç›®å‰åƒ…ç”¨æ–¼éæ¿¾ï¼Œä¸é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ï¼‰
confidence = 1 / (1 + 0.05 * rank)
// rank 1: 95%, rank 5: 80%, rank 10: 67%
```

## Chunking ç­–ç•¥

æ¯é–€èª²ç¨‹çš„æ•™å­¸å¤§ç¶±åˆ†æˆå¤šå€‹ chunksï¼š

| Chunk | å…§å®¹ | ç”¨é€” |
|-------|------|------|
| `{UID}_objectives_cn` | ã€èª²ç¨‹åç¨±ã€‘æ•™å­¸ç›®æ¨™ï¼š{CN} | åŒ¹é…ä¸­æ–‡æŸ¥è©¢ |
| `{UID}_objectives_en` | ã€èª²ç¨‹åç¨±ã€‘Course Objectives: {EN} | åŒ¹é…è‹±æ–‡æŸ¥è©¢ |
| `{UID}_outline_cn` | ã€èª²ç¨‹åç¨±ã€‘å…§å®¹ç¶±è¦ï¼š{CN} | åŒ¹é…ä¸»é¡ŒæŸ¥è©¢ |
| `{UID}_outline_en` | ã€Courseã€‘Course Outline: {EN} | åŒ¹é…è‹±æ–‡ä¸»é¡Œ |
| `{UID}_schedule` | ã€èª²ç¨‹åç¨±ã€‘æ•™å­¸é€²åº¦ï¼š... | åŒ¹é…é€±æ¬¡/é€²åº¦æŸ¥è©¢ |

**è¨­è¨ˆåŸå‰‡**:
- ä¸­è‹±æ–‡åˆ†é–‹å»ºç«‹ç¨ç«‹ chunkï¼Œæå‡åŒ¹é…æ¸…æ™°åº¦
- èª²ç¨‹åç¨±å‰ç¶´æä¾›ä¸Šä¸‹æ–‡ï¼Œæ”¹å–„çŸ­æŸ¥è©¢çš„åŒ¹é…
- åŒä¸€èª²ç¨‹å¤šå€‹ chunk åªä¿ç•™æœ€é«˜åˆ†çµæœ

## ä½¿ç”¨

```go
// åˆå§‹åŒ– BM25 ç´¢å¼•
bm25Index := rag.NewBM25Index(logger)

// è¼‰å…¥è³‡æ–™
syllabi, _ := db.GetAllSyllabi(ctx)
bm25Index.Initialize(syllabi)

// æœå°‹èª²ç¨‹
results, err := bm25Index.SearchCourses(ctx, "é›²ç«¯é‹ç®— AWS", 10)
for _, r := range results {
    fmt.Printf("%s (%.0f%% ä¿¡å¿ƒ)\n", r.Title, r.Confidence*100)
}

// é…åˆ Query Expansion
expander, _ := genai.NewQueryExpander(ctx, geminiAPIKey)
expanded, _ := expander.Expand(ctx, "AWS")
// "AWS" â†’ "AWS Amazon Web Services é›²ç«¯æœå‹™ é›²ç«¯é‹ç®—"
results, _ = bm25Index.SearchCourses(ctx, expanded, 10)
```

## å„²å­˜

- BM25 ç´¢å¼•: è¨˜æ†¶é«”ä¸­ï¼Œæ¯æ¬¡å•Ÿå‹•æ™‚å¾ SQLite é‡å»º
- Document ID æ ¼å¼: `{UID}_{chunk_type}`
- å•Ÿå‹•æ™‚è‡ªå‹•å¾ syllabi è¡¨è¼‰å…¥è³‡æ–™

## ä¾è³´

- `internal/genai`: Query Expanderï¼ˆå¯é¸ï¼Œéœ€ Gemini API Keyï¼‰
- `internal/storage`: Syllabus è³‡æ–™æ¨¡å‹
- `github.com/crawlab-team/bm25`: BM25 æ¼”ç®—æ³•å¯¦ç¾
