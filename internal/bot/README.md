# Bot Modules

è™•ç† LINE è¨Šæ¯äº‹ä»¶çš„æ ¸å¿ƒæ¨¡çµ„ï¼Œå¯¦ä½œ `Handler` ä»‹é¢ã€‚

## æ¶æ§‹

```
bot/
â”œâ”€â”€ handler.go      # Handler ä»‹é¢å®šç¾©
â”œâ”€â”€ utils.go        # å…±ç”¨å·¥å…·ï¼ˆé—œéµå­—åŒ¹é…ã€æœå°‹è©æå–ï¼‰
â”œâ”€â”€ id/             # å­¸è™ŸæŸ¥è©¢æ¨¡çµ„
â”œâ”€â”€ contact/        # è¯çµ¡è³‡è¨Šæ¨¡çµ„
â””â”€â”€ course/         # èª²ç¨‹æŸ¥è©¢æ¨¡çµ„
```

## Handler ä»‹é¢

```go
type Handler interface {
    CanHandle(text string) bool
    HandleMessage(ctx context.Context, text string) []messaging_api.MessageInterface
    HandlePostback(ctx context.Context, data string) []messaging_api.MessageInterface
}
```

### NLU DispatchIntentï¼ˆå¯é¸åŠŸèƒ½ï¼‰

å„æ¨¡çµ„é¡å¤–å¯¦ä½œ `DispatchIntent` æ–¹æ³•æ”¯æ´ NLU æ„åœ–åˆ†ç™¼ï¼ˆéœ€è¨­å®š `GEMINI_API_KEY` æˆ– `GROQ_API_KEY`ï¼‰ï¼š

```go
// DispatchIntent è™•ç† NLU è§£æå¾Œçš„æ„åœ–
// intent: æ„åœ–åç¨±ï¼ˆå¦‚ "search", "smart", "uid"ï¼‰
// params: è§£æå‡ºçš„åƒæ•¸ï¼ˆå¦‚ {"keyword": "å¾®ç©åˆ†"}ï¼‰
func (h *Handler) DispatchIntent(ctx context.Context, intent string, params map[string]string) ([]messaging_api.MessageInterface, error)
```

**ç‚ºä½•ä¸åœ¨ `Handler` ä»‹é¢ä¸­å®šç¾©ï¼Ÿ**

NLU æ˜¯**å¯é¸åŠŸèƒ½**ï¼ˆéœ€è¦ `GEMINI_API_KEY` æˆ– `GROQ_API_KEY`ï¼‰ï¼Œä¸æ˜¯æ‰€æœ‰éƒ¨ç½²ç’°å¢ƒéƒ½å•Ÿç”¨ã€‚éµå¾ª Go çš„ä»‹é¢è¨­è¨ˆåŸå‰‡ï¼š

1. **ä»‹é¢æœ€å°åŒ–**ï¼š`Handler` ä»‹é¢åªåŒ…å«å¿…è¦æ–¹æ³•ï¼ˆ`CanHandle`, `HandleMessage`, `HandlePostback`ï¼‰
2. **å¯é¸æ€§æª¢æ¸¬**ï¼šWebhook ä½¿ç”¨é¡å‹æ–·è¨€ `.(interface{ DispatchIntent(...) })` å‹•æ…‹æª¢æ¸¬æ”¯æ´
3. **é›¶ä¾è³´åŸå‰‡**ï¼šæœªå•Ÿç”¨ NLU æ™‚ï¼Œæ¨¡çµ„å®Œå…¨ç¨ç«‹é‹ä½œï¼Œä¸ä¾è³´ `genai` å¥—ä»¶

**å¯¦ä½œæ¨¡å¼**ï¼š
```go
// webhook/handler.go - å‹•æ…‹æª¢æ¸¬
if dispatcher, ok := handler.(interface{
    DispatchIntent(context.Context, string, map[string]string) ([]messaging_api.MessageInterface, error)
}); ok {
    // æ”¯æ´ NLUï¼Œä½¿ç”¨ DispatchIntent
    return dispatcher.DispatchIntent(ctx, intent, params)
}
// ä¸æ”¯æ´ NLUï¼Œfallback åˆ° HandleMessage
return handler.HandleMessage(ctx, rawText)
```

è©³è¦‹ `internal/genai/README.md` äº†è§£ NLU æ¶æ§‹ã€‚

## æ¨¡çµ„æ¦‚è¦½

### id/ - å­¸è™ŸæŸ¥è©¢
- **é—œéµå­—**ï¼šå­¸è™Ÿã€å­¸ç”Ÿã€å§“åã€ç§‘ç³»ã€ç³»ä»£ç¢¼ã€å­¸å¹´
- **åŠŸèƒ½**ï¼š
  - å­¸è™ŸæŸ¥è©¢ï¼ˆç›´æ¥è¼¸å…¥ 8-9 ä½æ•¸å­—ï¼‰
  - å§“åæœå°‹ï¼ˆ2-tier ä¸¦è¡Œæœå°‹ï¼Œæœ€å¤š 500 ç­†ï¼‰
  - ç³»ä»£ç¢¼å°ç…§
  - å­¸å¹´åº¦å­¸ç”Ÿåå–®ï¼ˆæŒ‰å­¸é™¢â†’ç§‘ç³»é¸æ“‡ï¼‰
- **æœå°‹ç­–ç•¥**ï¼šSQL LIKE (name) + æ¨¡ç³Š ContainsAllRunes (name)
- **Postback å‰ç¶´**ï¼š`id:`
- **Sender åç¨±**ï¼šå­¸è™Ÿå°å¹«æ‰‹

### contact/ - è¯çµ¡è³‡è¨Š
- **é—œéµå­—**ï¼šè¯ç¹«ã€è¯çµ¡ã€é›»è©±ã€åˆ†æ©Ÿã€ç·Šæ€¥
- **åŠŸèƒ½**ï¼š
  - å–®ä½/äººå“¡æœå°‹ï¼ˆ2-tier ä¸¦è¡Œæœå°‹ï¼‰
  - ç·Šæ€¥è¯çµ¡é›»è©±ï¼ˆä¸‰å³½/è‡ºåŒ—æ ¡å€ï¼‰
  - çµ„ç¹”æˆå“¡æŸ¥è©¢
- **æœå°‹ç­–ç•¥**ï¼šSQL LIKE (name, title) + æ¨¡ç³Š ContainsAllRunes (name, title, organization, superior)
- **Postback å‰ç¶´**ï¼š`contact:`
- **Sender åç¨±**ï¼šè¯ç¹«å°å¹«æ‰‹

### course/ - èª²ç¨‹æŸ¥è©¢
- **é—œéµå­—**ï¼šèª²ç¨‹ã€èª²ã€æ•™å¸«ã€è€å¸«ï¼ˆçµ±ä¸€æŸ¥è©¢ï¼‰
- **æ™ºæ…§é—œéµå­—**ï¼šæ‰¾èª²ã€æ‰¾èª²ç¨‹ã€æœèª²ï¼ˆç›´æ¥è§¸ç™¼æ™ºæ…§æœå°‹ï¼‰
- **åŠŸèƒ½**ï¼š
  - èª²ç¨‹åç¨±æœå°‹ï¼ˆæœ€å¤š 40 é–€ï¼‰
  - èª²ç¨‹ç·¨è™ŸæŸ¥è©¢ï¼ˆUID æ ¼å¼ï¼‰
  - çµ±ä¸€æŸ¥è©¢ï¼ˆ2-tier ä¸¦è¡Œæœå°‹ï¼šåŒæ™‚æœå°‹èª²ç¨‹åç¨±å’Œæ•™å¸«å§“åï¼‰
  - æ­·å²èª²ç¨‹æŸ¥è©¢ï¼ˆ`èª²ç¨‹ {å¹´åº¦} {é—œéµå­—}`ï¼‰
  - æ™ºæ…§æœå°‹ï¼ˆBM25 + Query Expansion æ™ºæ…§åŒ¹é…ï¼Œéœ€è¨­å®š `GEMINI_API_KEY` æˆ– `GROQ_API_KEY` ä»¥å•Ÿç”¨ Query Expansionï¼‰
- **æœå°‹ç­–ç•¥**ï¼š
  - ç²¾ç¢ºæœå°‹ï¼ˆèª²ç¨‹ï¼‰ï¼šSQL LIKE (title, teachers) + æ¨¡ç³Š ContainsAllRunes (title, teachers)
  - æ™ºæ…§æœå°‹ï¼ˆæ‰¾èª²ï¼‰ï¼šBM25 ç´¢å¼•æœå°‹ + LLM Query Expansion
- **Fallback ç­–ç•¥**ï¼šç²¾ç¢ºæœå°‹ç„¡çµæœæ™‚ï¼Œè‡ªå‹•å˜—è©¦ BM25 æ™ºæ…§æœå°‹ï¼ˆéœ€å•Ÿç”¨ BM25Indexï¼‰
- **Postback å‰ç¶´**ï¼š`course:`
- **Sender åç¨±**ï¼šèª²ç¨‹å°å¹«æ‰‹

**ä½¿ç”¨è€…æŒ‡å¼•**ï¼š
| æ–¹å¼ | é—œéµå­— | é©ç”¨æƒ…å¢ƒ | ç¯„ä¾‹ |
|------|--------|----------|------|
| ğŸ” ç²¾ç¢ºæœå°‹ | `èª²ç¨‹`ã€`è€å¸«` | çŸ¥é“èª²åæˆ–æ•™å¸«å | `èª²ç¨‹ å¾®ç©åˆ†`ã€`èª²ç¨‹ ç‹å°æ˜` |
| ğŸ”® æ™ºæ…§æœå°‹ | `æ‰¾èª²` | æè¿°æƒ³å­¸çš„å…§å®¹ | `æ‰¾èª² æƒ³å­¸è³‡æ–™åˆ†æ` |

## å…±ç”¨å·¥å…· (utils.go)

```go
// å»ºç«‹é—œéµå­—æ­£å‰‡ï¼ˆæŒ‰é•·åº¦æ’åºé¿å…çŸ­è©å…ˆåŒ¹é…ï¼‰
regex := bot.BuildKeywordRegex([]string{"èª²ç¨‹", "èª²"})

// æå–æœå°‹è©ï¼ˆç§»é™¤åŒ¹é…çš„é—œéµå­—ï¼‰
term := bot.ExtractSearchTerm("èª²ç¨‹ å¾®ç©åˆ†", "èª²ç¨‹") // â†’ "å¾®ç©åˆ†"
```

## æœå°‹ç­–ç•¥ï¼š2-Tier Parallel Search

æ‰€æœ‰æ¨¡çµ„çµ±ä¸€æ¡ç”¨ã€Œ2-tier ä¸¦è¡Œæœå°‹ã€ç­–ç•¥ï¼Œç¢ºä¿çµæœçš„å®Œæ•´æ€§èˆ‡ä¸€è‡´æ€§ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä½¿ç”¨è€…æŸ¥è©¢                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                           â”‚
        â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Tier 1: Cache   â”‚     â”‚   å¦‚æœ Cache ç„¡è³‡æ–™       â”‚
â”‚   (SQL LIKE +     â”‚     â”‚   â†’ Tier 2: Scraper       â”‚
â”‚    ContainsAll)   â”‚     â”‚      (çˆ¬å–å¾Œå­˜å…¥ Cache)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  åˆä½µ + å»é‡   â”‚
                â”‚  (by UID/ID)  â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒé‚è¼¯**ï¼š
1. **SQL LIKE**: å‚³çµ±å­å­—ä¸²åŒ¹é…ï¼Œé©åˆé€£çºŒå­—å…ƒæœå°‹ï¼ˆå¦‚ã€Œç·šæ€§ä»£æ•¸ã€ï¼‰
2. **ContainsAllRunes**: æ¨¡ç³Šå­—å…ƒé›†åŒ¹é…ï¼Œé©åˆç°¡ç¨±/ç¸®å¯«æœå°‹ï¼ˆå¦‚ã€Œç·šä»£ã€â†’ã€Œç·šæ€§ä»£æ•¸ã€ï¼‰
3. **å…©è€…ä¸¦è¡ŒåŸ·è¡Œ**ï¼Œçµæœåˆä½µå¾Œå»é‡ï¼ˆä¾ UID/IDï¼‰

**ç‚ºä½•ä¸ç”¨ fallbackï¼Ÿ**
åŸæœ¬çš„ fallback ç­–ç•¥ï¼ˆSQL LIKE ç„¡çµæœæ™‚æ‰åŸ·è¡Œ fuzzy searchï¼‰æœƒå°è‡´ï¼š
- ã€Œç·šä»£ã€â†’ SQL LIKE ç„¡çµæœ â†’ fuzzy æ‰¾åˆ°ã€Œç·šæ€§ä»£æ•¸ã€âœ…
- ã€Œç·šæ€§ä»£æ•¸ã€â†’ SQL LIKE æœ‰çµæœ â†’ è·³é fuzzy â†’ æ¼æ‰å…¶ä»–åŒ¹é… âŒ

**å‡½å¼ä½ç½®**ï¼š
- `bot.ContainsAllRunes(text, search)` - åˆ¤æ–· text æ˜¯å¦åŒ…å« search çš„æ‰€æœ‰å­—å…ƒï¼ˆruneï¼‰

## Fallback ç­–ç•¥ï¼ˆæƒ…å¢ƒåŒ–éŒ¯èª¤è¨Šæ¯ï¼‰

éµå¾ª **Nielsen Norman Group** çš„ 5 å¤§åŸå‰‡ï¼Œæä¾›é€æ˜ä¸”å…·å»ºè¨­æ€§çš„éŒ¯èª¤è¨Šæ¯ï¼š

### Fallback Context é¡å‹

```go
const (
    FallbackUnknownKeyword  // é—œéµå­—ç„¡æ³•åŒ¹é…
    FallbackNLUDisabled     // NLU æœªå•Ÿç”¨ï¼ˆæœªè¨­å®š API Keyï¼‰
    FallbackNLUFailed       // NLU è§£æå¤±æ•—
    FallbackDispatchFailed  // Intent åˆ†ç™¼å¤±æ•—
    FallbackUnknownModule   // NLU è¿”å›æœªçŸ¥æ¨¡çµ„
    FallbackGeneric         // é€šç”¨ fallback
)
```

### ä½¿ç”¨è€…é«”é©—ç›®æ¨™

æ ¹æ“šæ¥­ç•Œæœ€ä½³å¯¦è¸ç ”ç©¶ï¼Œè‰¯å¥½çš„ fallback è¨Šæ¯æ‡‰è©²ï¼š

1. **âœ… æ‰¿èªéŒ¯èª¤** - æ˜ç¢ºå‘ŠçŸ¥ä½¿ç”¨è€…ç™¼ç”Ÿäº†ä»€éº¼å•é¡Œ
2. **âœ… æ˜“æ–¼ç†è§£** - é¿å…æŠ€è¡“è¡“èªï¼Œä½¿ç”¨æ¸…æ™°çš„èªè¨€
3. **âœ… æ‰¿æ“”è²¬ä»»** - ä¸è²¬æ€ªä½¿ç”¨è€…ï¼Œèªªæ˜ç³»çµ±é™åˆ¶
4. **âœ… ç²¾ç¢ºèªªæ˜** - è§£é‡‹ç‚ºä»€éº¼ç„¡æ³•è™•ç†ï¼ˆæƒ…å¢ƒåŒ–ï¼‰
5. **âœ… æä¾›æŒ‡å¼•** - çµ¦äºˆæ˜ç¢ºçš„è¡Œå‹•å»ºè­°ï¼ˆQuick Reply + ç¯„ä¾‹ï¼‰

### æƒ…å¢ƒåŒ–è¨Šæ¯ç¯„ä¾‹

| Context | æ¨™é¡Œ | èªªæ˜ | æƒ…å¢ƒ |
|---------|------|------|------|
| `FallbackUnknownKeyword` | ğŸ¤” æ‰¾ä¸åˆ°ç›¸é—œåŠŸèƒ½ | ç›®å‰ç„¡æ³•ç†è§£æ­¤è¨Šæ¯ï¼Œè«‹è©¦è©¦ä»¥ä¸‹æ–¹å¼ | è¼¸å…¥ç„¡æ³•è¢«ä»»ä½•é—œéµå­—åŒ¹é… |
| `FallbackNLUDisabled` | ğŸ“– è«‹ä½¿ç”¨é—œéµå­— | ç›®å‰åƒ…æ”¯æ´é—œéµå­—æŸ¥è©¢ | NLU æœªå•Ÿç”¨ï¼ˆç„¡ API Keyï¼‰ |
| `FallbackNLUFailed` | ğŸ˜… ç„¡æ³•ç†è§£è¨Šæ¯ | è«‹è©¦è‘—æ›å€‹æ–¹å¼èªªæ˜ï¼Œæˆ–ä½¿ç”¨é—œéµå­— | NLU è§£æå¤±æ•— |
| `FallbackDispatchFailed` | âš ï¸ è™•ç†å¤±æ•— | ç³»çµ±æš«æ™‚ç„¡æ³•è™•ç†æ­¤è«‹æ±‚ | Intent åˆ†ç™¼å¤±æ•— |
| `FallbackGeneric` | ğŸ” åŒ—å¤§æŸ¥è©¢å°å·¥å…· | ç›´æ¥å°è©±æˆ–ä½¿ç”¨é—œéµå­—æŸ¥è©¢ | é€šç”¨ fallback |

**è¨­è¨ˆç†å¿µ**ï¼š
- **é€æ˜åº¦**ï¼šæ˜ç¢ºå‘ŠçŸ¥ä½¿ç”¨è€…ç‚ºä½•ç„¡æ³•è™•ç†ï¼ˆä¸æ˜¯ç°¡å–®çš„ã€Œæˆ‘ä¸æ‡‚ã€ï¼‰
- **å»ºè¨­æ€§**ï¼šæä¾›ç¯„ä¾‹å’Œ Quick Reply æŒ‡å¼•ä¸‹ä¸€æ­¥è¡Œå‹•
- **ä¸è²¬æ€ªä½¿ç”¨è€…**ï¼šä½¿ç”¨ã€Œç³»çµ±é™åˆ¶ã€è€Œéã€Œä½ çš„è¼¸å…¥éŒ¯èª¤ã€çš„èªæ°£
- **å‹•æ…‹èª¿æ•´**ï¼šæ ¹æ“šæ˜¯å¦å•Ÿç”¨ NLU èª¿æ•´èªªæ˜å…§å®¹

### åƒè€ƒè³‡æ–™

- Nielsen Norman Group: [Error Message Guidelines](https://www.nngroup.com/articles/error-message-guidelines/)
- [7 Chatbot Error Handling Strategies](https://quidget.ai/blog/ai-automation/7-chatbot-error-handling-strategies-for-better-ux/)
- [Perfecting the Chatbot Fallback Experience](https://uxplanet.org/perfecting-the-chatbot-fallback-experience-f76d119c45d4)

## é–‹ç™¼è¦ç¯„

1. **ä½¿ç”¨ `lineutil`**ï¼šæ‰€æœ‰è¨Šæ¯å»ºæ§‹é€é lineutilï¼Œä¸ç›´æ¥ä½¿ç”¨ LINE SDK
2. **Sender ä¸€è‡´æ€§**ï¼šæ¯æ¬¡å›è¦†ä½¿ç”¨åŒä¸€å€‹ `GetSender()` è¿”å›çš„ Sender
3. **Context timeout**ï¼š60 ç§’ï¼ˆLINE loading animation ä¸Šé™ï¼‰
4. **è¨Šæ¯é™åˆ¶**ï¼šæ¯æ¬¡æœ€å¤š 5 å‰‡è¨Šæ¯ï¼ˆLINE API é™åˆ¶ï¼‰
5. **Postback å‰ç¶´**ï¼šä½¿ç”¨ `{module}:` å‰ç¶´ä¾¿æ–¼ webhook dispatcher è·¯ç”±
6. **Table-driven tests**ï¼šæ‰€æœ‰æ¸¬è©¦ä½¿ç”¨ table-driven æ¨¡å¼
7. **Quick Reply å¼•å°**ï¼šåœ¨æœ€å¾Œä¸€å‰‡è¨Šæ¯é™„åŠ  Quick Reply å¼•å°ä¸‹ä¸€æ­¥
8. **Fallback é€æ˜åº¦**ï¼šä½¿ç”¨æƒ…å¢ƒåŒ–çš„ `FallbackContext` è®“ä½¿ç”¨è€…äº†è§£å•é¡ŒåŸå› 

## æ–°å¢æ¨¡çµ„æ­¥é©Ÿ

1. å»ºç«‹ `internal/bot/{module}/handler.go`
2. å¯¦ä½œ `Handler` ä»‹é¢
3. åœ¨ `webhook/handler.go` è¨»å†Šæ–° handler
4. å®šç¾© Postback å‰ç¶´ä¸¦åœ¨ dispatcher åŠ å…¥è·¯ç”±

è©³ç´°æ¶æ§‹è«‹åƒè€ƒ `.github/copilot-instructions.md`ã€‚
