# This Action requires setting the following secrets:
#
# - DOCKERHUB_TOKEN (create from https://hub.docker.com/settings/security)

name: Release

on:
  push:
    branches:
      - main
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile'
      - '.github/workflows/*.yml'
    tags:
      - 'v[0-9]*.[0-9]*.[0-9]*'

permissions:
  contents: read
  packages: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Release Image
    uses: ./.github/workflows/_docker-build.yml
    with:
      tags: |
        # 1. Exact version (e.g., 1.2.3) - Immutable
        type=semver,pattern={{version}}

        # 2. Minor version (e.g., 1.2) - Rolling tag (updates with 1.2.x)
        type=semver,pattern={{major}}.{{minor}}

        # 3. Major version (e.g., 1) - Rolling tag (updates with 1.x.x)
        type=semver,pattern={{major}}

        # 4. Latest tag - Points to the latest SemVer release
        type=semver,pattern=latest

        # 5. Dev tag - Points to the latest commit on default branch (main)
        type=raw,value=dev,enable={{is_default_branch}}
      push-to-dockerhub: true
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
