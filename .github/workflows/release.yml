# This Action requires setting the following secrets:
#
# - DOCKERHUB_TOKEN (create from https://hub.docker.com/settings/security)

name: Release

on:
  push:
    branches:
      - main
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile'
      - 'Dockerfile.alpine'
      - '.github/workflows/*.yml'
    tags:
      - 'v[0-9]*.[0-9]*.[0-9]*'

permissions:
  contents: read
  packages: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Build distroless variant (default, recommended for production)
  release-distroless:
    name: Release Distroless Image
    uses: ./.github/workflows/_docker-build.yml
    with:
      dockerfile: Dockerfile
      verify-base-image: true
      tags: |
        # 1. Exact version (e.g., 1.2.3) - Immutable
        type=semver,pattern={{version}}

        # 2. Minor version (e.g., 1.2) - Rolling tag (updates with 1.2.x)
        type=semver,pattern={{major}}.{{minor}}

        # 3. Major version (e.g., 1) - Rolling tag (updates with 1.x.x)
        type=semver,pattern={{major}}

        # 4. Latest tag - Points to the latest SemVer release
        type=semver,pattern=latest

        # 5. Dev tag - Points to the latest commit on default branch (main)
        type=raw,value=dev,enable={{is_default_branch}}
      push-to-dockerhub: true
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

  # Build Alpine variant (for special scenarios where distroless is not supported)
  release-alpine:
    name: Release Alpine Image
    uses: ./.github/workflows/_docker-build.yml
    with:
      dockerfile: Dockerfile.alpine
      verify-base-image: false
      flavor: |
        suffix=-alpine,onlatest=true
      tags: |
        # 1. Exact version with alpine suffix (e.g., 1.2.3-alpine)
        type=semver,pattern={{version}}

        # 2. Minor version with alpine suffix (e.g., 1.2-alpine)
        type=semver,pattern={{major}}.{{minor}}

        # 3. Major version with alpine suffix (e.g., 1-alpine)
        type=semver,pattern={{major}}

        # 4. Alpine tag - Points to the latest SemVer Alpine release (no suffix)
        type=semver,pattern=alpine,suffix=

        # 5. Dev-alpine tag - Points to the latest commit on default branch (no suffix)
        type=raw,value=dev-alpine,enable={{is_default_branch}},suffix=
      push-to-dockerhub: true
    secrets:
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
